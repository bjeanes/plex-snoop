# Notes on API requests and their purpose

Some of this exists at [`Arcanemagus/plex-api` wiki](https://github.com/Arcanemagus/plex-api/wiki/Plex.tv) too.

TODO: Find a way to capture everything from `mitmproxy` output and generate entries for anything new.

## `GET https://meta.plex.tv/metadata/key`

Returns a value to be used as a token for metadata provider.

e.g. response:

```
abcdef123456
```

## `GET https://metadata.provider.plex.tv/`

* Requires `X-Plex-Token` request header
* May require `X-Plex-Client-Identifier` - appears to be random (generated by client or PMS), typically hex, but not
  always (Android client is "<hex prefix>-com-plexapp-android" for instance)
* `X-Plex-Token` should be the _reverse_ of the value returned from `/metadata/key`. In other words, if `/metadata/key`
  returned `abc`, send `cba`

e.g. response:

```
<?xml version="1.0"?>
<MediaProvider icon="https://provider-static.plex.tv/icons/metadata-560.svg" identifier="tv.plex.provider.metadata" protocols="stream" version="1.3.0" title="Metadata">
  <Feature type="metadata" key="/library/metadata"/>
  <Feature type="actions">
    <Action id="addToWatchlist" key="/actions/addToWatchlist" reverseKey="/actions/removeFromWatchlist"/>
  </Feature>
  <Feature type="location" key="/location"/>
  <Feature type="imagetranscoder" public="1" key="https://transcoder.plex.tv/photo"/>
  <Feature flavor="universal" type="playqueue" key="https://play.provider.plex.tv/playQueues"/>
  <Feature type="match" key="/library/metadata/matches"/>
</MediaProvider>
```

## `POST https://plex.tv/devices/:client_id/unclaimed?Connection[][uri]=https://server-host:32400`

Registers PMS with plex.tv?

e.g. request headers

```
X-Plex-Client-Identifier :	2ec1352c1d4c5c1b4540e082675b86e9c47cf778
X-Plex-Product :	Plex Media Server
X-Plex-Version :	1.22.1.4228-724c56e62
X-Plex-Provides :	server
X-Plex-Platform :	Linux
X-Plex-Platform-Version :	5.11.6-arch1-1
X-Plex-Device-Name :	8c1c5593f774
X-Plex-Device :	Docker Container
X-Plex-Model :	x86_64
X-Plex-Device-Vendor :	Docker
```

## `POST https://plex.tv/api/claim/exchange?token=claim-<claim-token>`

* unclear where claim token comes from, probably OAuth flow
* returns XML representing authenticated user
* an authentication token is given in both `authenticationToken` and `authToken` attributes of root node

e.g. response:

```
<?xml version="1.0" encoding="UTF-8"?>
<user email="redacted" id="redacted" uuid="redacted" mailing_list_status="unsubscribed" thumb="redacted" username="redacted" title="redacted" cloudSyncDevice="" locale="en-GB" authenticationToken="redacted" authToken="redacted" scrobbleTypes="" pin="redacted" restricted="0" home="1" guest="0" queueEmail="redacted" queueUid="" hasPassword="true" homeSize="2" maxHomeSize="15" secure="1" certificateVersion="3">
  <subscription active="1" status="Active" plan="lifetime">
    <feature id="webhooks"/>
    <feature id="content_filter"/>
    <feature id="camera_upload"/>
    <feature id="home"/>
    <feature id="pass"/>
    <feature id="music_videos"/>
    <feature id="trailers"/>
    <feature id="dvr"/>
    <feature id="session_bandwidth_restrictions"/>
    <feature id="adaptive_bitrate"/>
    <feature id="collections"/>
    <feature id="premium_music_metadata"/>
    <feature id="photos-metadata-edition"/>
    <feature id="cloudsync"/>
    <feature id="lyrics"/>
    <feature id="hardware_transcoding"/>
    <feature id="sync"/>
    <feature id="session_kick"/>
    <feature id="radio"/>
    <feature id="tuner-sharing"/>
    <feature id="hwtranscode"/>
    <feature id="photos-favorites"/>
    <feature id="photosV6-edit"/>
    <feature id="photosV6-tv-albums"/>
    <feature id="federated-auth"/>
    <feature id="item_clusters"/>
    <feature id="livetv"/>
    <feature id="Android - PiP"/>
    <feature id="photos-v5"/>
    <feature id="unsupportedtuners"/>
    <feature id="kevin-bacon"/>
    <feature id="client-radio-stations"/>
    <feature id="imagga-v2"/>
    <feature id="silence-removal"/>
    <feature id="boost-voices"/>
    <feature id="volume-leveling"/>
    <feature id="sweet-fades"/>
    <feature id="sleep-timer"/>
    <feature id="TREBLE-show-features"/>
    <feature id="web_server_dashboard"/>
    <feature id="visualizers"/>
    <feature id="premium-dashboard"/>
    <feature id="conan_redirect_qa"/>
    <feature id="conan_redirect_alpha"/>
    <feature id="conan_redirect_beta"/>
    <feature id="conan_redirect_public"/>
    <feature id="news_local_now"/>
    <feature id="nominatim"/>
    <feature id="transcoder_cache"/>
    <feature id="live-tv-support-incomplete-segments"/>
    <feature id="dvr-block-unsupported-countries"/>
    <feature id="companions_sonos"/>
    <feature id="allow_dvr"/>
    <feature id="signin_notification"/>
    <feature id="exclude restrictions"/>
    <feature id="signin_with_apple"/>
    <feature id="drm_support"/>
    <feature id="Android - Dolby Vision"/>
    <feature id="epg-recent-channels"/>
    <feature id="spring_serve_ad_provider"/>
    <feature id="lets_encrypt"/>
    <feature id="conan_redirect_nightlies"/>
    <feature id="conan_redirect_nightly"/>
    <feature id="watch-together-invite"/>
    <feature id="ios14-privacy-banner"/>
    <feature id="two-factor-authentication"/>
    <feature id="amazon-loop-debug"/>
    <feature id="retro-games-plex-tv"/>
    <feature id="vod_cloudflare"/>
    <feature id="grandfather-sync"/>
    <feature id="downloads-gating"/>
    <feature id="optimize-server-users-endpoint"/>
    <feature id="CU Sunset"/>
    <feature id="reorder-media-providers"/>
    <feature id="news-provider-sunset-modal"/>
  </subscription>
  <roles>
    <role id="plexpass"/>
  </roles>
  <entitlements all="1">
    <entitlement id="ios"/>
    <entitlement id="android_beta"/>
    <entitlement id="ios_beta"/>
    <entitlement id="roku"/>
    <entitlement id="android"/>
    <entitlement id="xbox_one"/>
    <entitlement id="xbox_360"/>
    <entitlement id="windows"/>
    <entitlement id="windows_phone"/>
  </entitlements>
  <profile_settings default_audio_language="en" default_subtitle_language="en" auto_select_subtitle="1" auto_select_audio="1" default_subtitle_accessibility="0" default_subtitle_forced="0"/>
  <providers>
    <provider id="google_federated" uid="redacted" token="redacted"/>
  </providers>
  <services>
    <service identifier="epg" endpoint="https://epg.provider.plex.tv" token="redacted" status="online"/>
    <service identifier="epg-staging" endpoint="https://epg-staging.provider.plex.tv" token="redacted" status="online"/>
    <service identifier="epg-dev" endpoint="https://epg-dev.provider.plex.tv" token="redacted" status="online"/>
    <service identifier="eyeq" endpoint="https://c4412416.ipg.web.cddbp.net/webapi/xml/1.0/" token="redacted" status="online"/>
    <service identifier="eyeq-channel-icons" endpoint="http://akamai-b.cdn.cddbp.net/cds/2.0/image" status="online"/>
    <service identifier="imagga-v2" endpoint="https://api.imagga.com/v2" token="redacted" secret="redacted" status="online"/>
    <service identifier="nominatim" endpoint="https://locationiq.org/v1" token="redacted" status="online"/>
    <service identifier="metadata" endpoint="https://metadata.provider.plex.tv" token="redacted" status="online"/>
    <service identifier="metadata-dev" endpoint="https://metadata-dev.provider.plex.tv" token="redacted" status="online"/>
    <service identifier="metadata-provider" endpoint="https://mpm.plex.tv/" status="online"/>
    <service identifier="tmsapi" endpoint="https://tmsapi.plex.tv/v1.1/" token="redacted" status="online"/>
    <service identifier="subtitles-search" endpoint="https://metadata.provider.plex.tv/library/metadata/matches" token="redacted" status="online"/>
    <service identifier="acoustid" endpoint="https://acoustid.plex.tv/" token="redacted" status="online"/>
    <service identifier="lyricfind" endpoint="https://lyricfind.plex.tv/" token="redacted" secret="redacted" status="online"/>
    <service identifier="lyricfind-search" endpoint="https://lyricfind.plex.tv/" token="redacted" status="online"/>
  </services>
  <username>redacted</username>
  <email>redacted</email>
  <joined-at type="datetime">2011-10-30 15:01:15 UTC</joined-at>
  <authentication-token>redacted</authentication-token>
</user>
```

## `PUT https://plex.tv/api/servers/:client_id/connectivity?X-Plex-Token=<token>&asyncIdentifier=<uuid>`

Registers PMS with plex.tv?

## `PUT
https://plex.tv/devices/:client_id?Connection[][uri]=http://server-url:32400&httpsEnabled=0&dnsRebindingProtection=0&X-Plex-Token=<token>`

Registers PMS with plex.tv?

## `GET https://plex.tv/services/pubsub/servers`

* Requires `X-Plex-Token` header

e.g. response:

```
<Servers size="20">
  <Server host="176.58.107.84" region="lhr"/>
  <Server host="176.58.127.172" region="lhr"/>
  <Server host="139.162.120.52" region="hnd"/>
  <Server host="139.162.75.196" region="hnd"/>
  <Server host="172.104.145.70" region="fra"/>
  <Server host="172.104.132.7" region="fra"/>
  <Server host="139.162.40.38" region="sin"/>
  <Server host="139.162.57.189" region="sin"/>
  <Server host="172.105.29.107" region="yyz"/>
  <Server host="172.105.99.32" region="yyz"/>
  <Server host="184.105.148.118" region="sjc"/>
  <Server host="184.105.148.116" region="sjc"/>
  <Server host="45.33.119.35" region="dfw"/>
  <Server host="45.33.125.156" region="dfw"/>
  <Server host="172.104.217.190" region="ewr"/>
  <Server host="172.104.24.90" region="ewr"/>
  <Server host="45.79.197.58" region="atl"/>
  <Server host="45.56.116.228" region="atl"/>
  <Server host="82.94.168.22" region="ams"/>
  <Server host="82.94.168.18" region="ams"/>
</Servers>
```

## `GET https://plex.tv/api/resources.xml?includeHttps=1&includeRelay=1&auth_token=<token>`

Lists all devices reported to Plex.TV that the owning account has access to.

E.g. response:

```
<?xml version="1.0" encoding="UTF-8"?>
<MediaContainer size="11">
  <Device name="Tumtum tree" product="Plex Media Server" productVersion="1.22.1.4228-724c56e62" platform="Linux" platformVersion="4.15.0-132-generic" device="Docker Container" clientIdentifier="redacted" createdAt="1562495340" lastSeenAt="1616652678" provides="server" owned="1" accessToken="redacted" publicAddress="redacted" httpsRequired="0" synced="0" relay="0" dnsRebindingProtection="0" natLoopbackSupported="1" publicAddressMatches="1" presence="1">
    <Connection protocol="https" address="redacted" port="32400" uri="redacted" local="1"/>
    <Connection protocol="https" address="redacted" port="32400" uri="redacted" local="1"/>
    <Connection protocol="http" address="redacted" port="32400" uri="redacted" local="0"/>
    <Connection protocol="https" address="redacted" port="32400" uri="redacted" local="1"/>
    <Connection protocol="https" address="redacted" port="32400" uri="redacted" local="0"/>
    <Connection protocol="https" address="redacted" port="32400" uri="redacted" local="0"/>
  </Device>
  <Device name="the-boulder" product="Plex Media Server" productVersion="1.21.1.3876-3c3adfcb4" platform="Linux" platformVersion="16.04.3 LTS (Xenial Xerus)" device="PC" clientIdentifier="redacted" createdAt="1518929675" lastSeenAt="1616641491" provides="server" owned="0" publicAddress="redacted" httpsRequired="0" ownerId="27249" home="0" accessToken="redacted" sourceTitle="chendo" synced="0" relay="1" dnsRebindingProtection="1" natLoopbackSupported="0" publicAddressMatches="0" presence="0">
    <Connection protocol="https" address="redacted" port="32400" uri="redacted" local="1"/>
    <Connection protocol="https" address="redacted" port="32400" uri="redacted" local="1"/>
    <Connection protocol="https" address="redacted" port="32400" uri="redacted" local="1"/>
    <Connection protocol="https" address="redacted" port="32400" uri="redacted" local="0"/>
  </Device>
  <Device name="Pixel 3" product="Plex for Android (Mobile)" productVersion="8.15.0.23770" platform="Android" platformVersion="11" device="Pixel 3" clientIdentifier="redacted" createdAt="1576401393" lastSeenAt="1616664950" provides="player,pubsub-player,controller,sync-target" owned="1" publicAddress="redacted" publicAddressMatches="1" presence="0">
    <Connection protocol="http" address="redacted" port="32500" uri="redacted" local="1"/>
  </Device>
</MediaContainer>
```
